#!/bin/bash

# VM Deployment Script for Distributed Log Query System
# Replace these variables with your actual values
grp="ssh snh6@fa21-cs425-g71-01.cs.illinois.edu"  # Your group number
netid="nithishsujay"  # Your NetID
folderName="g71"  # The folder name where the repo is cloned

echo "Deploying Distributed Log Query System to CS425 VMs..."
echo "Group: $grp"
echo "NetID: $netid"
echo "Folder: $folderName"
echo ""

# Function to deploy on a specific VM
deploy_vm() {
    local vm_num=$1
    local machine_id=$2
    local port=$3
    
    echo "*******************************************************************************************"
    echo "***********************************Deploying on VM $vm_num ***********************************"
    
    # Build the system on the VM
    ssh $netid@fa21-cs425-g`printf $grp`-`printf %02d $vm_num`.cs.illinois.edu "
        cd $folderName
        echo 'Building system on VM $vm_num...'
        make clean
        make all
        echo 'System built successfully on VM $vm_num'
        echo 'Generated files:'
        ls -la server-grpc client-grpc
        exit
    "
}

# Deploy on VMs 1-3 (for our 3-server setup)
deploy_vm 1 1 8080
deploy_vm 2 2 8081  
deploy_vm 3 3 8082

echo ""
echo "Deployment complete!"
echo ""
echo "Next steps:"
echo "1. Start servers on VMs:"
echo "   VM1: ssh $netid@fa21-cs425-g${grp}-01.cs.illinois.edu 'cd $folderName && ./server-grpc -machine=1 -port=8080'"
echo "   VM2: ssh $netid@fa21-cs425-g${grp}-02.cs.illinois.edu 'cd $folderName && ./server-grpc -machine=2 -port=8081'"
echo "   VM3: ssh $netid@fa21-cs425-g${grp}-03.cs.illinois.edu 'cd $folderName && ./server-grpc -machine=3 -port=8082'"
echo ""
echo "2. Test from any VM:"
echo "   ssh $netid@fa21-cs425-g${grp}-01.cs.illinois.edu 'cd $folderName && ./client-grpc \"ERROR\" -servers=\"fa21-cs425-g${grp}-01.cs.illinois.edu:8080,fa21-cs425-g${grp}-02.cs.illinois.edu:8081,fa21-cs425-g${grp}-03.cs.illinois.edu:8082\"'"
